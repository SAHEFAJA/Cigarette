<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پخش دخانیات محمدی - محصولات باکیفیت و لوکس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vazirmatn font for elegant Persian typography -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for modern icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for the body, applying the Vazirmatn font and a dark theme */
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #1a202c; /* Dark charcoal background */
            color: #e2e8f0; /* Soft white text for readability */
            scroll-behavior: smooth; /* Smooth scrolling for "back to top" */
        }

        /* Custom scrollbar for a sleek, modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* Slightly lighter thumb */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #616161; /* Even lighter on hover */
        }

        /* Keyframe animation for a subtle button press effect */
        @keyframes press {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        /* Apply the press animation on button click */
        .btn-press:active {
            animation: press 0.2s ease-in-out;
        }

        /* Keyframe animation for fade-in/fade-out for modals and notifications */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }

        /* Apply fade-in animation for modal entry */
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Apply fade-out animation for modal exit */
        .modal-exit {
            animation: fadeOut 0.3s ease-in forwards;
        }

        /* Custom styles for mobile navigation (off-canvas menu) */
        .mobile-menu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%); /* Hidden by default, slides from right */
        }
        .mobile-menu.active {
            transform: translateX(0); /* Visible when active */
        }

        /* Notification styles */
        .notification {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .notification.hide {
            animation: fadeOut 0.3s ease-in forwards;
        }

        /* Hide number input spin buttons for a cleaner look */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }

        /* Hero section specific styles */
        .hero-section {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://placehold.co/1920x600/1e293b/e2e8f0?text=Luxury+Tobacco+Distribution') no-repeat center center;
            background-size: cover;
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.8) 100%);
            z-index: 1;
        }
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            padding: 2rem;
        }

        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px; /* Space between text and spinner */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header Section -->
    <header id="main-header" class="bg-gray-900 p-4 shadow-xl transition-shadow duration-300">
        <div class="container mx-auto flex justify-between items-center flex-wrap">
            <!-- Brand Logo/Title with hover effect -->
            <h1 class="text-4xl font-extrabold text-teal-400 mb-2 md:mb-0 transform hover:scale-105 transition duration-300">
                <span class="text-gray-300">پخش دخانیات</span> محمدی
            </h1>

            <!-- Mobile-specific controls: Hamburger menu and Cart button -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-button" class="text-gray-400 hover:text-teal-300 focus:outline-none text-2xl p-2 rounded-md btn-press" aria-label="باز کردن منوی موبایل">
                    <i class="fas fa-bars"></i>
                </button>
                <button id="cart-button-mobile" class="relative text-gray-400 hover:text-teal-300 transition duration-300 focus:outline-none p-2 rounded-md btn-press ml-4" aria-label="مشاهده سبد خرید">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5.4M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count-mobile" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-gray-900">0</span>
                </button>
            </div>

            <!-- Desktop Navigation Menu -->
            <nav class="hidden md:flex">
                <ul class="flex space-x-4 space-x-reverse text-lg">
                    <li><a href="#" class="text-gray-400 hover:text-teal-300 transition duration-300 px-3 py-2 rounded-md" aria-label="خانه">خانه</a></li>
                    <li><a href="#product-grid-section" class="text-gray-400 hover:text-teal-300 transition duration-300 px-3 py-2 rounded-md" aria-label="محصولات">محصولات</a></li>
                    <li><a href="#footer-section" class="text-gray-400 hover:text-teal-300 transition duration-300 px-3 py-2 rounded-md" aria-label="تماس با ما">تماس با ما</a></li>
                    <li>
                        <button id="cart-button-desktop" class="relative text-gray-400 hover:text-teal-300 transition duration-300 focus:outline-none p-2 rounded-md btn-press" aria-label="مشاهده سبد خرید">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5.4M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span id="cart-count-desktop" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-gray-900">0</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Mobile Navigation Menu (Off-canvas sidebar) -->
    <div id="mobile-menu" class="mobile-menu fixed top-0 right-0 w-64 h-full bg-gray-800 shadow-lg z-40 p-6 md:hidden">
        <button id="close-mobile-menu" class="absolute top-4 left-4 text-gray-400 hover:text-red-500 text-3xl font-bold focus:outline-none btn-press" aria-label="بستن منوی موبایل">&times;</button>
        <nav class="mt-10">
            <ul class="flex flex-col space-y-6 text-xl">
                <li><a href="#" class="block text-gray-300 hover:text-teal-300 transition duration-300 py-2">خانه</a></li>
                <li><a href="#product-grid-section" class="block text-gray-300 hover:text-teal-300 transition duration-300 py-2">محصولات</a></li>
                <li><a href="#footer-section" class="block text-gray-300 hover:text-teal-300 transition duration-300 py-2">تماس با ما</a></li>
            </ul>
        </nav>
    </div>

    <!-- Hero Section -->
    <section class="hero-section text-white">
        <div class="hero-content">
            <h2 class="text-5xl md:text-6xl font-extrabold mb-6 leading-tight drop-shadow-lg">
                کیفیت و اصالت در پخش دخانیات
            </h2>
            <p class="text-lg md:text-xl mb-8 opacity-90">
                پخش دخانیات محمدی، ارائه‌دهنده برترین و لوکس‌ترین محصولات دخانی در ایران.
            </p>
            <a href="#product-grid-section" class="inline-block bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 shadow-lg transform hover:scale-105 btn-press">
                مشاهده محصولات
            </a>
        </div>
    </section>

    <!-- Main Content Area -->
    <main class="container mx-auto p-6 flex-grow">
        <h2 id="product-grid-section" class="text-5xl font-extrabold text-center text-teal-300 mb-12 mt-8 leading-tight">
            محصولات ویژه "پخش دخانیات محمدی"
        </h2>

        <!-- Search Bar with improved styling and accessibility -->
        <div class="mb-10 flex justify-center">
            <input type="text" id="search-input" placeholder="جستجو بر اساس نام محصول..."
                   class="w-full max-w-md p-4 rounded-lg bg-gray-700 text-white placeholder-gray-400
                          focus:outline-none focus:ring-2 focus:ring-teal-500 border border-gray-600 shadow-md text-lg text-right"
                   dir="rtl" aria-label="جستجوی محصولات">
        </div>

        <!-- Product Grid where product cards will be dynamically rendered -->
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            <!-- Product cards will be injected here by JavaScript -->
        </div>
    </main>

    <!-- Product Quick View Modal -->
    <div id="quick-view-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden p-4"
         role="dialog" aria-modal="true" tabindex="-1">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative border border-gray-700">
            <button id="close-quick-view-modal" class="absolute top-4 left-4 text-gray-400 hover:text-red-500 text-3xl font-bold focus:outline-none transition duration-300 btn-press" aria-label="بستن نمای سریع">&times;</button>
            <div id="quick-view-content" class="flex flex-col md:flex-row items-center md:items-start gap-6">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Cart Modal (Shopping Cart Overlay) -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden p-4"
         role="dialog" aria-modal="true" tabindex="-1">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative border border-gray-700">
            <button id="close-cart-modal" class="absolute top-4 left-4 text-gray-400 hover:text-red-500 text-3xl font-bold focus:outline-none transition duration-300 btn-press" aria-label="بستن سبد خرید">&times;</button>
            <h3 class="text-3xl font-bold text-teal-300 mb-8 text-center border-b border-gray-700 pb-4">سبد خرید شما</h3>
            <div id="cart-items" class="space-y-6">
                <!-- Cart items will be injected here by JavaScript -->
            </div>
            <div class="border-t border-gray-700 pt-6 mt-8 flex justify-between items-center text-2xl font-semibold">
                <span>جمع کل:</span>
                <span id="cart-total" class="text-teal-400">0 تومان</span>
            </div>
            <button id="checkout-button" class="mt-10 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg transition duration-300 shadow-lg transform hover:scale-105 focus:outline-none btn-press" aria-label="تکمیل سفارش و ارسال به تلگرام">
                تکمیل سفارش و ارسال به تلگرام
            </button>
        </div>
    </div>

    <!-- Global Notification Container (for toast messages) -->
    <div id="notification-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] space-y-3 w-full max-w-xs md:max-w-sm">
        <!-- Notifications will be appended here -->
    </div>

    <!-- Footer Section -->
    <footer id="footer-section" class="bg-gray-900 p-6 text-center text-gray-500 text-sm mt-10 shadow-inner">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 text-right md:text-center">
            <div>
                <h4 class="text-lg font-semibold text-teal-300 mb-3">درباره ما</h4>
                <p class="leading-relaxed">پخش دخانیات محمدی با سال‌ها تجربه، بهترین و اصیل‌ترین محصولات دخانی را با بالاترین کیفیت به مشتریان عزیز عرضه می‌کند.</p>
            </div>
            <div>
                <h4 class="text-lg font-semibold text-teal-300 mb-3">تماس با ما</h4>
                <p>آدرس: ایران، استان خوزستان، بندر ماهشهر، خیابان اصلی، پلاک ۱۲۳</p>
                <p>تلفن: <a href="tel:+986123456789" class="hover:text-teal-300 transition duration-200">۰۶۱-۲۳۴۵۶۷۸۹</a></p>
                <p>واتساپ: <a href="https://wa.me/989339376061" target="_blank" class="hover:text-teal-300 transition duration-200">۹۸۹۳۳۹۳۷۶۰۶۱</a></p>
                <p>ایمیل: <a href="mailto:info@mohammadi-tobacco.com" class="hover:text-teal-300 transition duration-200">info@mohammadi-tobacco.com</a></p>
            </div>
            <div>
                <h4 class="text-lg font-semibold text-teal-300 mb-3">لینک‌های مفید</h4>
                <ul>
                    <li><a href="#" class="hover:text-teal-300 transition duration-200">سوالات متداول</a></li>
                    <li><a href="#" class="hover:text-teal-300 transition duration-200">سیاست حفظ حریم خصوصی</a></li>
                    <li><a href="#" class="hover:text-teal-300 transition duration-200">شرایط و ضوابط</a></li>
                </ul>
            </div>
        </div>
        <p class="mt-8 border-t border-gray-700 pt-6">&copy; 2025 پخش دخانیات محمدی. تمامی حقوق محفوظ است.</p>
        <p class="mt-3">با احترام و کیفیت، در خدمت شما هستیم.</p>
    </footer>

    <!-- Back to Top Button -->
    <button id="back-to-top" class="fixed bottom-6 right-6 bg-teal-600 hover:bg-teal-700 text-white p-4 rounded-full shadow-lg transition duration-300 transform hover:scale-110 focus:outline-none hidden btn-press" aria-label="بازگشت به بالای صفحه">
        <i class="fas fa-arrow-up text-xl"></i>
    </button>

    <script>
        // Array of sample products for the store
        // These descriptions are tailored for a distribution business.
        const products = [
            {
                id: 1,
                name: "سیگار وینستون قرمز",
                price: 95000, // Random price
                image: "https://placehold.co/400x300/1e293b/e2e8f0?text=Winston+Red",
                description: "سیگار وینستون قرمز، طعم اصیل و قوی برای علاقه‌مندان به تجربه‌ای کلاسیک.",
                fullDescription: "وینستون قرمز، نمادی از قدرت و اصالت در دنیای سیگار. این محصول با استفاده از بهترین توتون‌ها و فرآیند تولید دقیق، طعمی غنی و دودی کامل را ارائه می‌دهد که برای کسانی که به دنبال تجربه‌ای سنتی و قوی هستند، ایده‌آل است. بسته‌بندی شیک و کیفیت ثابت، آن را به انتخابی محبوب تبدیل کرده است."
            },
            {
                id: 2,
                name: "سیگار وینستون لایت",
                price: 90000, // Random price
                image: "https://placehold.co/400x300/1e293b/e2e8f0?text=Winston+Light",
                description: "سیگار وینستون لایت، تجربه‌ای ملایم‌تر با همان کیفیت و اصالت وینستون.",
                fullDescription: "وینستون لایت، گزینه‌ای عالی برای کسانی که به دنبال طعمی ملایم‌تر بدون از دست دادن کیفیت وینستون هستند. این سیگار با فیلترهای پیشرفته و ترکیب توتون‌های خاص، دودی نرم و تجربه‌ای سبک‌تر را فراهم می‌کند. مناسب برای استفاده روزمره و لحظات آرامش‌بخش."
            },
            {
                id: 3,
                name: "سیگار وینستون الترا",
                price: 100000, // Random price
                image: "https://placehold.co/400x300/1e293b/e2e8f0?text=Winston+Ultra",
                description: "سیگار وینستون الترا، نهایت سبکی و طراوت در خانواده وینستون.",
                fullDescription: "وینستون الترا، سبک‌ترین و تازه‌ترین تجربه را در میان محصولات وینستون ارائه می‌دهد. با طراحی فیلترهای فوق‌العاده و توتون‌های خاص، این سیگار دودی بسیار ملایم و مطبوع دارد که برای علاقه‌مندان به سیگارهای فوق سبک، انتخابی بی‌نظیر است. تجربه‌ای خنک و دلپذیر در هر پک."
            }
        ];

        // Cart array to store items added by the user
        let cart = [];

        // --- Telegram Bot API Configuration ---
        // !!! IMPORTANT SECURITY WARNING !!!
        // Exposing your bot token and chat ID directly in client-side code (like this JavaScript file)
        // is a SIGNIFICANT SECURITY RISK. Anyone viewing your website's source code can see and misuse
        // your bot token, potentially sending spam, accessing private chats, or performing other
        // unauthorized actions.
        //
        // FOR PRODUCTION ENVIRONMENTS, IT IS HIGHLY RECOMMENDED TO:
        // 1. Create a simple backend server (e.g., Node.js, Python, PHP) to handle Telegram API calls.
        // 2. Store your TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID securely on that server (e.g., in environment variables).
        // 3. Your frontend (this HTML/JS) should send the order details to your backend server.
        // 4. The backend server then makes the secure call to the Telegram API.
        //
        // This setup protects your sensitive credentials.
        //
        // For demonstration purposes in this interactive environment, placeholders are used.
        const TELEGRAM_BOT_TOKEN = '7564001901:AAHn0TcUuUh8oo7JylERY7dFjo74SdshdqU'; // <--- *** توکن ربات تلگرام شما ***
        const TELEGRAM_CHAT_ID = '7757681083';     // <--- *** Chat ID شما (یا کانال) اینجا قرار داده شد ***
        // ------------------------------------

        // Get references to DOM elements for manipulation
        const mainHeader = document.getElementById('main-header');
        const productGrid = document.getElementById('product-grid');
        const cartCountDesktopSpan = document.getElementById('cart-count-desktop');
        const cartCountMobileSpan = document.getElementById('cart-count-mobile');
        const cartButtonDesktop = document.getElementById('cart-button-desktop');
        const cartButtonMobile = document.getElementById('cart-button-mobile');
        const cartModal = document.getElementById('cart-modal');
        const closeCartModalButton = document.getElementById('close-cart-modal');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalSpan = document.getElementById('cart-total');
        const checkoutButton = document.getElementById('checkout-button');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenuButton = document.getElementById('close-mobile-menu');
        const searchInput = document.getElementById('search-input');
        const backToTopButton = document.getElementById('back-to-top');
        const notificationContainer = document.getElementById('notification-container');
        const quickViewModal = document.getElementById('quick-view-modal');
        const closeQuickViewModalButton = document.getElementById('close-quick-view-modal');
        const quickViewContent = document.getElementById('quick-view-content');

        /**
         * Formats a number as a currency string with commas.
         * @param {number} price - The number to format.
         * @returns {string} The formatted price string.
         */
        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        /**
         * Renders products based on a search query.
         * If query is empty, renders all products.
         * @param {string} query - The search query.
         */
        function renderProducts(query = '') {
            productGrid.innerHTML = ''; // Clear any existing product cards
            const filteredProducts = products.filter(product =>
                product.name.toLowerCase().includes(query.toLowerCase()) ||
                product.description.toLowerCase().includes(query.toLowerCase()) ||
                (product.fullDescription && product.fullDescription.toLowerCase().includes(query.toLowerCase()))
            );

            if (filteredProducts.length === 0) {
                productGrid.innerHTML = '<p class="col-span-full text-center text-gray-400 text-xl py-10">محصولی با این مشخصات یافت نشد.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productCard = `
                    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition duration-300 cursor-pointer border border-gray-700 group product-card" data-id="${product.id}">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-56 object-cover object-center rounded-t-xl group-hover:opacity-80 transition-opacity duration-300" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2d3748/e2e8f0?text=Image+Not+Found';">
                        <div class="p-6">
                            <h3 class="text-2xl font-semibold text-teal-300 mb-2">${product.name}</h3>
                            <p class="text-gray-400 text-sm mb-4 h-12 overflow-hidden">${product.description}</p>
                            <div class="flex flex-col items-center mt-4">
                                <span class="text-3xl font-bold text-white mb-4">${formatPrice(product.price)} تومان</span>
                                <div class="flex items-center space-x-3 space-x-reverse w-full justify-center mb-4">
                                    <button data-id="${product.id}" class="quantity-input-btn bg-gray-600 hover:bg-gray-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold focus:outline-none transition duration-200 btn-press" data-action="decrease-input" aria-label="کاهش تعداد">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" value="1" min="1" data-product-id="${product.id}"
                                           class="product-quantity-input w-20 text-center bg-gray-700 text-white rounded-md p-2
                                                  focus:outline-none focus:ring-2 focus:ring-teal-500"
                                           aria-label="تعداد محصول">
                                    <button data-id="${product.id}" class="quantity-input-btn bg-gray-600 hover:bg-gray-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold focus:outline-none transition duration-200 btn-press" data-action="increase-input" aria-label="افزایش تعداد">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <button data-product-id="${product.id}" class="add-to-cart-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md transform hover:scale-105 focus:outline-none btn-press w-full" aria-label="افزودن به سبد خرید">
                                    افزودن به سبد
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productGrid.innerHTML += productCard;
            });

            // Attach event listeners to all "Add to Cart" buttons after they are rendered
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent quick view modal from opening
                    const productId = parseInt(event.target.dataset.productId);
                    const quantityInput = document.querySelector(`.product-quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseInt(quantityInput.value);
                    addToCart(productId, quantity, event.target); // Pass the button element
                });
            });

            // Attach event listeners to quantity input buttons
            document.querySelectorAll('.quantity-input-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent quick view modal from opening
                    const productId = parseInt(event.target.dataset.id);
                    const action = event.target.dataset.action;
                    const quantityInput = document.querySelector(`.product-quantity-input[data-product-id="${productId}"]`);
                    let currentValue = parseInt(quantityInput.value);

                    if (action === 'increase-input') {
                        quantityInput.value = currentValue + 1;
                    } else if (action === 'decrease-input' && currentValue > 1) {
                        quantityInput.value = currentValue - 1;
                    }
                });
            });

            // Attach event listeners for quick view on product cards
            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const productId = parseInt(event.currentTarget.dataset.id);
                    showQuickView(productId);
                });
            });
        }

        /**
         * Displays the quick view modal for a given product.
         * @param {number} productId - The ID of the product to display.
         */
        function showQuickView(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            quickViewContent.innerHTML = `
                <div class="md:w-1/2 flex justify-center">
                    <img src="${product.image}" alt="${product.name}" class="w-full max-w-sm rounded-lg shadow-lg border border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/400x300/2d3748/e2e8f0?text=Image+Not+Found';">
                </div>
                <div class="md:w-1/2 text-right">
                    <h3 class="text-3xl font-bold text-teal-300 mb-4">${product.name}</h3>
                    <p class="text-gray-300 text-md mb-6 leading-relaxed">${product.fullDescription || product.description}</p>
                    <span class="text-4xl font-bold text-white mb-6 block">${formatPrice(product.price)} تومان</span>
                    <div class="flex items-center space-x-3 space-x-reverse w-full justify-end mb-6">
                        <button data-id="${product.id}" class="quick-view-quantity-btn bg-gray-600 hover:bg-gray-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold focus:outline-none transition duration-200 btn-press" data-action="decrease-quick-view" aria-label="کاهش تعداد">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" value="1" min="1" data-product-id="${product.id}"
                               class="quick-view-quantity-input w-20 text-center bg-gray-700 text-white rounded-md p-2
                                      focus:outline-none focus:ring-2 focus:ring-teal-500"
                               aria-label="تعداد محصول">
                        <button data-id="${product.id}" class="quick-view-quantity-btn bg-gray-600 hover:bg-gray-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold focus:outline-none transition duration-200 btn-press" data-action="increase-quick-view" aria-label="افزایش تعداد">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <button data-product-id="${product.id}" class="add-to-cart-from-quick-view-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md transform hover:scale-105 focus:outline-none btn-press w-full">
                        افزودن به سبد
                    </button>
                </div>
            `;

            openModal(quickViewModal); // Use the generic openModal function

            // Attach event listeners for quantity buttons in quick view
            document.querySelectorAll('.quick-view-quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = parseInt(event.target.dataset.id);
                    const action = event.target.dataset.action;
                    const quantityInput = document.querySelector(`.quick-view-quantity-input[data-product-id="${productId}"]`);
                    let currentValue = parseInt(quantityInput.value);

                    if (action === 'increase-quick-view') {
                        quantityInput.value = currentValue + 1;
                    } else if (action === 'decrease-quick-view' && currentValue > 1) {
                        quantityInput.value = currentValue - 1;
                    }
                });
            });

            // Attach event listener for "Add to Cart" button in quick view
            document.querySelector('.add-to-cart-from-quick-view-btn').addEventListener('click', (event) => {
                const productId = parseInt(event.target.dataset.productId);
                const quantityInput = document.querySelector(`.quick-view-quantity-input[data-product-id="${productId}"]`);
                const quantity = parseInt(quantityInput.value);
                addToCart(productId, quantity, event.target); // Pass the button element
                closeModal(quickViewModal); // Close quick view after adding to cart
            });
        }

        /**
         * Adds a product to the cart or increments its quantity if already present.
         * @param {number} productId - The ID of the product to add.
         * @param {number} quantity - The quantity to add.
         * @param {HTMLElement} [buttonElement] - The button element that triggered the add to cart.
         */
        function addToCart(productId, quantity, buttonElement = null) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({ ...product, quantity: quantity });
                }
                updateCartCount(); // Update the cart icon badge
                renderCartItems(); // Re-render items in the cart modal

                // Provide visual feedback on the button
                if (buttonElement) {
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = '<i class="fas fa-check ml-2"></i> اضافه شد';
                    buttonElement.classList.add('bg-green-600', 'hover:bg-green-700');
                    buttonElement.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700');
                        buttonElement.classList.add('bg-teal-600', 'hover:bg-teal-700');
                    }, 1500); // Revert after 1.5 seconds
                }

                showNotification(`"${product.name}" به سبد خرید اضافه شد.`, 'success');
            }
        }

        /**
         * Updates the numerical count displayed on the cart icons.
         */
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountDesktopSpan.textContent = totalItems;
            cartCountMobileSpan.textContent = totalItems;
        }

        /**
         * Renders all items currently in the 'cart' array into the cart modal.
         * Also calculates and displays the total price.
         */
        function renderCartItems() {
            cartItemsContainer.innerHTML = ''; // Clear previous cart items
            let total = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-400 text-lg py-4">سبد خرید شما خالی است.</p>';
            } else {
                cart.forEach(item => {
                    const cartItemDiv = `
                        <div class="flex flex-col sm:flex-row items-center justify-between bg-gray-700 p-4 rounded-lg shadow-sm border border-gray-600">
                            <div class="flex items-center mb-4 sm:mb-0">
                                <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md ml-4 border border-gray-500" onerror="this.onerror=null;this.src='https://placehold.co/80x80/2d3748/e2e8f0?text=No+Image';">
                                <div>
                                    <h4 class="text-xl font-semibold text-white">${item.name}</h4>
                                    <p class="text-gray-300 text-sm">${formatPrice(item.price)} تومان</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <button data-id="${item.id}" class="quantity-btn bg-gray-600 hover:bg-gray-500 text-white w-9 h-9 rounded-full flex items-center justify-center text-xl font-bold focus:outline-none transition duration-200 btn-press" data-action="decrease" aria-label="کاهش تعداد">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="text-white text-lg font-bold">${item.quantity}</span>
                                <button data-id="${item.id}" class="quantity-btn bg-gray-600 hover:bg-gray-500 text-white w-9 h-9 rounded-full flex items-center justify-center text-xl font-bold focus:outline-none transition duration-200 btn-press" data-action="increase" aria-label="افزایش تعداد">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button data-id="${item.id}" class="remove-from-cart-btn text-red-500 hover:text-red-600 transition duration-300 focus:outline-none ml-2 btn-press" aria-label="حذف از سبد خرید">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsContainer.innerHTML += cartItemDiv;
                    total += item.price * item.quantity;
                });
            }

            cartTotalSpan.textContent = `${formatPrice(total)} تومان`;

            // Attach event listeners for quantity adjustment buttons in the cart using event delegation
            cartItemsContainer.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = parseInt(event.currentTarget.dataset.id);
                    const action = event.currentTarget.dataset.action; // 'increase' or 'decrease'
                    updateQuantity(itemId, action);
                });
            });

            // Attach event listeners for remove item buttons in the cart using event delegation
            cartItemsContainer.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = parseInt(event.currentTarget.dataset.id);
                    removeFromCart(itemId);
                });
            });
        }

        /**
         * Updates the quantity of a specific item in the cart.
         * @param {number} itemId - The ID of the item to update.
         * @param {string} action - 'increase' to increment, 'decrease' to decrement.
         */
        function updateQuantity(itemId, action) {
            const itemIndex = cart.findIndex(item => item.id === itemId);
            if (itemIndex > -1) {
                if (action === 'increase') {
                    cart[itemIndex].quantity++;
                } else if (action === 'decrease') {
                    cart[itemIndex].quantity--;
                    if (cart[itemIndex].quantity <= 0) {
                        cart.splice(itemIndex, 1); // Remove item if quantity drops to 0 or less
                        showNotification('محصول از سبد خرید حذف شد.', 'info');
                    }
                }
                updateCartCount(); // Update cart badge
                renderCartItems(); // Re-render cart modal content
            }
        }

        /**
         * Removes an item completely from the cart.
         * @param {number} itemId - The ID of the item to remove.
         */
        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId); // Filter out the item to be removed
            updateCartCount(); // Update cart badge
            renderCartItems(); // Re-render cart modal content
            showNotification('محصول از سبد خرید حذف شد.', 'info');
        }

        /**
         * Displays a temporary notification (toast message) at the bottom center.
         * @param {string} message - The message to display.
         * @param {string} type - Type of message ('success', 'info', 'error').
         */
        function showNotification(message, type = 'info') {
            const notificationDiv = document.createElement('div');
            let bgColor = '';
            let iconHtml = '';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-600';
                    iconHtml = '<i class="fas fa-check-circle ml-2"></i>';
                    break;
                case 'error':
                    bgColor = 'bg-red-600';
                    iconHtml = '<i class="fas fa-times-circle ml-2"></i>';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-600';
                    iconHtml = '<i class="fas fa-info-circle ml-2"></i>';
                    break;
            }

            notificationDiv.className = `notification flex items-center p-4 rounded-lg shadow-xl text-white ${bgColor}`;
            notificationDiv.innerHTML = `${iconHtml}<span>${message}</span>`;
            notificationContainer.appendChild(notificationDiv);

            // Set a timeout to hide and remove the notification
            setTimeout(() => {
                notificationDiv.classList.add('hide');
                notificationDiv.addEventListener('animationend', () => notificationDiv.remove());
            }, 3000); // Notification disappears after 3 seconds
        }

        /**
         * Debounce function to limit how often a function can run.
         * Useful for events like 'input' on search fields.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Opens a modal and applies entry animation.
         * @param {HTMLElement} modalElement - The modal DOM element.
         */
        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('modal-enter');
            modalElement.focus(); // Focus the modal for accessibility
        }

        /**
         * Closes a modal and applies exit animation.
         * @param {HTMLElement} modalElement - The modal DOM element.
         */
        function closeModal(modalElement) {
            modalElement.classList.add('modal-exit');
            modalElement.addEventListener('animationend', () => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('modal-exit', 'modal-enter');
            }, { once: true });
        }

        // Event listener to open the cart modal when the cart button is clicked (desktop)
        cartButtonDesktop.addEventListener('click', () => {
            openModal(cartModal);
            renderCartItems(); // Ensure cart items are up-to-date when modal opens
        });

        // Event listener to open the cart modal when the cart button is clicked (mobile)
        cartButtonMobile.addEventListener('click', () => {
            openModal(cartModal);
            renderCartItems(); // Ensure cart items are up-to-date when modal opens
            mobileMenu.classList.remove('active'); // Close mobile menu if open
        });

        // Event listener to close the cart modal when the close button is clicked
        closeCartModalButton.addEventListener('click', () => {
            closeModal(cartModal);
        });

        // Event listener to close the cart modal when clicking outside the modal content
        cartModal.addEventListener('click', (event) => {
            if (event.target === cartModal) { // Check if the click was directly on the modal background
                closeModal(cartModal);
            }
        });

        // Event listener for the "Checkout" button
        checkoutButton.addEventListener('click', async () => {
            if (cart.length === 0) {
                showNotification('سبد خرید شما خالی است!', 'error');
                return;
            }

            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                showNotification('لطفاً توکن ربات تلگرام و Chat ID خود را در کد JavaScript تنظیم کنید. (برای محیط واقعی، این مقادیر باید در بک‌اند نگهداری شوند.)', 'error');
                return;
            }

            // Show loading state on the button
            const originalButtonText = checkoutButton.innerHTML;
            checkoutButton.innerHTML = '<span class="spinner"></span> در حال ساخت فاکتور...';
            checkoutButton.disabled = true;
            checkoutButton.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                // Generate current date in Persian format and a simple invoice number
                const currentDate = new Date().toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const invoiceNumber = Date.now().toString().slice(-6); // Last 6 digits of timestamp for simplicity

                let totalOrderPrice = 0;
                let itemsList = "";
                cart.forEach(item => {
                    const itemTotalPrice = item.price * item.quantity;
                    itemsList += ` - ${item.name} | تعداد: ${item.quantity} | مبلغ کل: ${formatPrice(itemTotalPrice)} تومان\n`;
                    totalOrderPrice += itemTotalPrice;
                });

                // Construct the prompt for image generation
                const imagePrompt = `
                    یک تصویر فاکتور حرفه ای و تمیز برای 'پخش دخانیات محمدی' (Mohammadi Tobacco Distribution) ایجاد کن.
                    فاکتور باید برای اندازه کاغذ A5، در حالت عمودی (portrait) طراحی شود.
                    باید شامل موارد زیر باشد:
                    - نام شرکت: 'پخش دخانیات محمدی'
                    - تلفن: '۰۶۱-۲۳۴۵۶۷۸۹'
                    - تاریخ: ${currentDate}
                    - شماره فاکتور: ${invoiceNumber}
                    - یک جدول با ستون‌های: 'شرح کالا' (Item Description)، 'تعداد' (Quantity)، 'مبلغ کل' (Total Amount).
                    - لیست هر یک از اقلام سبد خرید به شرح زیر:
                    ${itemsList}
                    - جمع کل: ${formatPrice(totalOrderPrice)} تومان
                    - فضای خالی برای 'امضا خریدار' (Buyer's Signature) و 'مهر فروشنده' (Seller's Stamp).
                    - از یک فونت مدرن و زیبا مناسب برای متن فارسی استفاده کن.
                    - طراحی باید مینیمالیستی و حرفه‌ای باشد و برای چاپ مناسب باشد.
                `;

                // Call the image generation API
                const apiKey = ""; // Canvas provides this
                const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const imagePayload = {
                    instances: { prompt: imagePrompt },
                    parameters: { "sampleCount": 1 }
                };

                const imageResponse = await fetch(imageUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(imagePayload)
                });

                const imageData = await imageResponse.json();

                if (imageData.predictions && imageData.predictions.length > 0 && imageData.predictions[0].bytesBase64Encoded) {
                    const base64Image = imageData.predictions[0].bytesBase64Encoded;
                    const byteCharacters = atob(base64Image);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/png' });

                    // Create FormData to send the image as a file
                    const formData = new FormData();
                    formData.append('chat_id', TELEGRAM_CHAT_ID);
                    formData.append('photo', blob, 'invoice.png'); // 'invoice.png' is the filename

                    const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`;

                    const telegramResponse = await fetch(telegramApiUrl, {
                        method: 'POST',
                        body: formData // No Content-Type header needed for FormData
                    });

                    const telegramData = await telegramResponse.json();

                    if (telegramData.ok) {
                        showNotification('فاکتور عکسی شما با موفقیت به تلگرام ارسال شد.', 'success');
                        // Clear the cart after successful submission
                        cart = [];
                        updateCartCount();
                        renderCartItems();
                        closeModal(cartModal); // Close cart modal
                    } else {
                        console.error('Telegram API Error:', telegramData);
                        showNotification(`خطا در ارسال فاکتور به تلگرام: ${telegramData.description || 'نامشخص'}`, 'error');
                    }
                } else {
                    console.error('Image Generation API Error:', imageData);
                    showNotification('خطا در تولید تصویر فاکتور. لطفاً دوباره تلاش کنید.', 'error');
                }
            } catch (error) {
                console.error('Network or API call error:', error);
                showNotification('خطایی در اتصال رخ داد. لطفاً دوباره تلاش کنید.', 'error');
            } finally {
                // Revert button state
                checkoutButton.innerHTML = originalButtonText;
                checkoutButton.disabled = false;
                checkoutButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        // Mobile menu toggle
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.add('active');
        });

        closeMobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
        });

        // Close mobile menu when clicking outside
        mobileMenu.addEventListener('click', (event) => {
            if (event.target === mobileMenu) {
                mobileMenu.classList.remove('active');
            }
        });

        // Close quick view modal
        closeQuickViewModalButton.addEventListener('click', () => closeModal(quickViewModal));
        quickViewModal.addEventListener('click', (event) => {
            if (event.target === quickViewModal) {
                closeModal(quickViewModal);
            }
        });

        // Global Escape key listener to close open modals
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (!cartModal.classList.contains('hidden')) {
                    closeModal(cartModal);
                }
                if (!quickViewModal.classList.contains('hidden')) {
                    closeModal(quickViewModal);
                }
                if (mobileMenu.classList.contains('active')) {
                    mobileMenu.classList.remove('active');
                }
            }
        });

        // Debounced search functionality
        const debouncedRenderProducts = debounce(renderProducts, 300); // 300ms delay
        searchInput.addEventListener('input', (event) => {
            const query = event.target.value;
            debouncedRenderProducts(query);
        });

        // Back to Top button functionality
        window.addEventListener('scroll', () => {
            // Add shadow to header on scroll
            if (window.scrollY > 0) {
                mainHeader.classList.add('shadow-2xl');
            } else {
                mainHeader.classList.remove('shadow-2xl');
            }

            // Show/hide back to top button
            if (window.scrollY > 300) { // Show button after scrolling 300px
                backToTopButton.classList.remove('hidden');
            } else {
                backToTopButton.classList.add('hidden');
            }
        });

        backToTopButton.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scroll to top
            });
        });

        // Initial setup when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts(); // Display all products on page load
            updateCartCount(); // Initialize cart count to 0
        });
    </script>
</body>
</html>

